# Reference Property Generation Bug

## Problem Summary

KiCad schematics generated by circuit-synth display component references as "R?", "C?", "U?" instead of proper numbered references like "R1", "C1", "U1". This affects both the visual display in KiCad and the functionality of the schematics.

## Visual Evidence

![Reference Property Bug](../reference_troubleshooting_screenshot.png)
*Components showing "R?" instead of "R1" in KiCad schematic view*

## Root Cause Analysis

### Initial Investigation

The issue stems from commit `879f8b0` "Fix component text positioning in KiCad schematics" which changed how the `kicad_symbol_parser.py` stores symbol properties.

### Before (Working)
```python
# kicad_symbol_parser.py - Line ~134 (before 879f8b0)
result["properties"][prop_name] = prop_value  # "C" -> direct string
```

### After (Broken)
```python
# kicad_symbol_parser.py - Line ~134 (after 879f8b0)
prop_info = {"value": prop_value}  # "C" -> {"value": "C"} dictionary
# ... additional positioning and effects parsing ...
result["properties"][prop_name] = prop_info
```

### Impact Chain

1. **Parser Change**: Properties now stored as dictionaries with "value" key instead of direct strings
2. **Symbol Cache Issue**: `symbol_cache.py` expects string values but receives dictionaries
3. **S-Expression Generation**: Symbol library definitions get malformed property templates
4. **KiCad Display**: Components show dictionary strings instead of proper references

## Technical Details

### File Locations and Issues

**`src/circuit_synth/kicad/kicad_symbol_parser.py` (Line ~134)**
- Changed property storage from strings to dictionary objects
- Added positioning and effects information (good feature)
- Broke downstream code expecting string values (bad side effect)

**`src/circuit_synth/core/symbol_cache.py` (Line ~588)**
```python
# This line now gets {"value": "C"} instead of "C"
reference = properties.get("Reference", "U")
```

**`src/circuit_synth/core/s_expression.py` (Line ~1323)**
```python
# This passes the dictionary to KiCad template generation
("Reference", symbol_def.reference_prefix, [0, 0, 0])
```

### Example of Malformed Output

Generated KiCad schematic shows:
```sexp
(property
    "Reference"
    "{'value': 'C', 'position': {'x': 0.635, 'y': 2.54, 'rotation': 0.0}, 'effects': {'font_size': [1.27, 1.27], 'justify': ['left']}}"
    (at 0.0 0.0 0)
    ...
)
```

Instead of:
```sexp
(property
    "Reference"
    "C?"
    (at 0.0 0.0 0)
    ...
)
```

## Investigation Progress (August 2025)

### Phase 1: Initial Analysis (Completed ‚úÖ)
- **Issue Confirmed**: Components display as "R?" instead of "R1" in KiCad
- **Root Cause Identified**: Commit `879f8b0` changed property storage from strings to dictionaries
- **Impact Scope**: Affects both symbol library definitions AND component instances

### Phase 2: Code Architecture Simplification (Completed ‚úÖ)
- **Removed Duplicate Files**: Eliminated unused `src/circuit_synth/core/s_expression.py`
- **Consolidated Symbol Generation**: Now using single `kicad_api` path only
- **Improved Debugging**: Added comprehensive logging throughout the pipeline

### Phase 3: Partial Fix Implementation (Completed ‚úÖ)

#### Fixed Components:
- **Component Instances**: ‚úÖ Now correctly display "R1", "10k" instead of dictionary strings
- **Property Extraction**: ‚úÖ Enhanced `symbol_cache.py` with proper dictionary handling
- **Reference Generation**: ‚úÖ Component references work correctly in schematic instances

#### Implementation Details:
```python
# Enhanced property extraction in kicad_api/core/symbol_cache.py
def extract_property_value(prop_name, fallback=""):
    prop_data = properties.get(prop_name, fallback)
    if isinstance(prop_data, dict):
        return prop_data.get("value", fallback)
    return str(prop_data) if prop_data else fallback

# Successful extraction confirmed by debug logs:
# üîß KICAD_API DEBUG: Dictionary reference - raw={'value': 'R', ...}, extracted=R
# üîß S_EXPRESSION DEBUG: symbol_def.reference_prefix = R (type: <class 'str'>)
```

### Current Status (Updated August 3, 2025)

- ‚úÖ **Component instances**: Fixed - properly display "R1", "10k"
- ‚úÖ **Property extraction**: Fixed - SymbolDefinition objects created correctly
- ‚úÖ **Debug visibility**: Added comprehensive logging for troubleshooting
- ‚ùå **Symbol library templates**: Still broken - show dictionary strings
- ‚ùå **KiCad visual display**: Still shows "R?" in schematic view

### Remaining Issue Analysis

**Problem**: Symbol library definitions still contain malformed dictionary strings:
```sexp
(property
    "Reference" 
    "{'value': 'R', 'position': {'x': 2.032, 'y': 0.0, 'rotation': 90.0}, 'effects': {'font_size': [1.27, 1.27]}}"
    (at 0.0 0.0 0)
    ...
)
```

**Evidence**: Debug logs show property extraction working correctly, but generated output still malformed. This indicates **two separate code paths**:
1. **Component instance generation** (‚úÖ working)
2. **Symbol library template generation** (‚ùå still using raw dictionary data)

### Next Steps Required

1. **Locate Alternative Symbol Generation Path**: Find code that bypasses SymbolDefinition processing
2. **Fix Raw Dictionary Usage**: Ensure all symbol generation uses proper property extraction
3. **Complete Testing**: Verify KiCad displays proper references ("R1" not "R?")

### Files Modified

- `src/circuit_synth/kicad_api/core/symbol_cache.py` - Enhanced property extraction
- `src/circuit_synth/kicad_api/core/s_expression.py` - Added debug logging
- `src/circuit_synth/core/s_expression.py` - Removed (duplicate file)

## Testing

### Reproduction Steps
1. Run `uv run example_project/circuit-synth/main.py`
2. Open generated KiCad project in KiCad
3. Observe components showing "R?", "C?", "U?" instead of proper references

### Verification Steps
1. Check symbol library definitions in `.kicad_sch` files
2. Look for Python dictionary strings in property values
3. Verify KiCad displays proper component references

### Test Files
- `bidirectional_update_test/step1_imported_python/` - Simple test case
- `example_project/circuit-synth/` - Complex hierarchical example

## Git History

**Key Commits:**
- `879f8b0` - "Fix component text positioning in KiCad schematics" (introduced bug)
- `fd44eca` - "Fix reference property generation bug" (partial fix)

## Next Steps

1. ‚úÖ Document the problem (this file)
2. ‚è≥ Fix s_expression.py to handle dictionary properties
3. ‚è≥ Test complete fix across all scenarios
4. ‚è≥ Ensure backward compatibility maintained
5. ‚è≥ Update any other property extraction points

## Branch Information

- **Current Branch**: `fix/reference-property-generation-bug`
- **Base Branch**: `develop`
- **Related Branch**: `feature/bidirectional-kicad-updates` (contains partial fix)

---

*This document tracks the investigation and resolution of the reference property generation bug affecting KiCad schematic display in circuit-synth.*