<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit-Synth TAC Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8b949e;
            margin-bottom: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
        }

        .card h2 {
            color: #58a6ff;
            font-size: 1.2em;
            margin-bottom: 15px;
            border-bottom: 1px solid #21262d;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #21262d;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #8b949e;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .status-good { color: #3fb950; }
        .status-warning { color: #d29922; }
        .status-error { color: #f85149; }

        .task-list {
            list-style: none;
        }

        .task-item {
            background: #0d1117;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #58a6ff;
        }

        .task-item.priority-0 { border-left-color: #f85149; }
        .task-item.priority-1 { border-left-color: #d29922; }
        .task-item.priority-2 { border-left-color: #58a6ff; }

        .task-id {
            font-weight: bold;
            color: #58a6ff;
            margin-right: 10px;
        }

        .task-desc {
            color: #c9d1d9;
        }

        .task-meta {
            font-size: 0.85em;
            color: #8b949e;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #0d1117;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3fb950 0%, #58a6ff 100%);
            transition: width 0.3s ease;
        }

        .worker-item {
            background: #0d1117;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .timestamp {
            text-align: right;
            color: #8b949e;
            font-size: 0.85em;
            margin-top: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå Circuit-Synth TAC Dashboard</h1>
        <p class="subtitle">Autonomous Coordination System Monitoring</p>

        <!-- System Metrics -->
        <div class="grid">
            <div class="card">
                <h2>üìä System Resources</h2>
                <div class="metric">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value" id="cpu-percent">--</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="cpu-bar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value" id="memory-percent">--</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="memory-bar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Disk Usage</span>
                    <span class="metric-value" id="disk-percent">--</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="disk-bar" style="width: 0%"></div>
                </div>
                <div class="metric" id="thermal-metric" style="display: none;">
                    <span class="metric-label">CPU Temperature</span>
                    <span class="metric-value" id="cpu-temp">--</span>
                </div>
            </div>

            <div class="card">
                <h2>üìù Task Queue</h2>
                <div class="metric">
                    <span class="metric-label">Pending</span>
                    <span class="metric-value status-warning" id="pending-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active</span>
                    <span class="metric-value status-good" id="active-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Completed</span>
                    <span class="metric-value status-good" id="completed-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Failed</span>
                    <span class="metric-value status-error" id="failed-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Blocked</span>
                    <span class="metric-value status-warning" id="blocked-count">0</span>
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Active Workers</h2>
                <div id="workers-container">
                    <p style="color: #8b949e;">No active workers</p>
                </div>
            </div>
        </div>

        <!-- Pending Tasks -->
        <div class="card">
            <h2>üìã Pending Tasks</h2>
            <ul class="task-list" id="pending-tasks">
                <li style="color: #8b949e;">No pending tasks</li>
            </ul>
        </div>

        <!-- Active Tasks -->
        <div class="card">
            <h2>üîÑ Active Tasks</h2>
            <ul class="task-list" id="active-tasks">
                <li style="color: #8b949e;">No active tasks</li>
            </ul>
        </div>

        <div class="timestamp">
            Last updated: <span id="last-updated">--</span>
        </div>
    </div>

    <script>
        // API base URL (adjust if needed)
        const API_URL = '';

        // Update interval (5 seconds)
        const UPDATE_INTERVAL = 5000;

        // Fetch and update metrics
        async function updateDashboard() {
            try {
                // Fetch all metrics
                const response = await fetch(`${API_URL}/api/metrics`);
                const data = await response.json();

                // Update system metrics
                updateSystemMetrics(data.system);

                // Update task counts
                updateTaskCounts(data.tasks);

                // Update workers
                updateWorkers(data.workers);

                // Update task lists
                updateTaskLists(data.active_tasks);

                // Update thermal (if available)
                if (data.thermal) {
                    updateThermal(data.thermal);
                }

                // Update timestamp
                document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleString();
            } catch (error) {
                console.error('Failed to update dashboard:', error);
            }
        }

        function updateSystemMetrics(system) {
            document.getElementById('cpu-percent').textContent = system.cpu_percent.toFixed(1) + '%';
            document.getElementById('cpu-bar').style.width = system.cpu_percent + '%';

            document.getElementById('memory-percent').textContent = system.memory_percent.toFixed(1) + '%';
            document.getElementById('memory-bar').style.width = system.memory_percent + '%';

            document.getElementById('disk-percent').textContent = system.disk_percent.toFixed(1) + '%';
            document.getElementById('disk-bar').style.width = system.disk_percent + '%';

            // Color code based on usage
            const cpuBar = document.getElementById('cpu-bar');
            cpuBar.style.background = system.cpu_percent > 80 ? '#f85149' : (system.cpu_percent > 60 ? '#d29922' : '#3fb950');

            const memBar = document.getElementById('memory-bar');
            memBar.style.background = system.memory_percent > 80 ? '#f85149' : (system.memory_percent > 60 ? '#d29922' : '#3fb950');
        }

        function updateTaskCounts(tasks) {
            document.getElementById('pending-count').textContent = tasks.pending_count;
            document.getElementById('active-count').textContent = tasks.active_count;
            document.getElementById('completed-count').textContent = tasks.completed_count;
            document.getElementById('failed-count').textContent = tasks.failed_count;
            document.getElementById('blocked-count').textContent = tasks.blocked_count;
        }

        function updateWorkers(workers) {
            const container = document.getElementById('workers-container');
            if (workers.length === 0) {
                container.innerHTML = '<p style="color: #8b949e;">No active workers</p>';
                return;
            }

            container.innerHTML = workers.map(worker => `
                <div class="worker-item">
                    <strong>${worker.worker_id}</strong> - ${worker.task_id}
                    ${worker.status === 'not_found' ?
                        '<span style="color: #8b949e;"> (not running)</span>' :
                        `<div style="color: #8b949e; font-size: 0.85em; margin-top: 5px;">
                            CPU: ${worker.cpu_percent?.toFixed(1)}% |
                            Memory: ${worker.memory_mb?.toFixed(1)} MB |
                            PID: ${worker.pid}
                        </div>`
                    }
                </div>
            `).join('');
        }

        async function updateTaskLists(activeTasks) {
            // Fetch detailed task list
            const response = await fetch(`${API_URL}/api/tasks`);
            const tasks = await response.json();

            // Update pending tasks
            const pendingContainer = document.getElementById('pending-tasks');
            if (tasks.pending.length === 0) {
                pendingContainer.innerHTML = '<li style="color: #8b949e;">No pending tasks</li>';
            } else {
                pendingContainer.innerHTML = tasks.pending.map(task => `
                    <li class="task-item priority-${task.priority}">
                        <span class="task-id">${task.task_id}</span>
                        <span class="task-desc">${task.description}</span>
                        <div class="task-meta">Priority: P${task.priority}</div>
                    </li>
                `).join('');
            }

            // Update active tasks
            const activeContainer = document.getElementById('active-tasks');
            if (tasks.active.length === 0) {
                activeContainer.innerHTML = '<li style="color: #8b949e;">No active tasks</li>';
            } else {
                activeContainer.innerHTML = tasks.active.map(task => `
                    <li class="task-item">
                        <span class="task-id">${task.task_id}</span>
                        <span class="task-desc">${task.description}</span>
                        <div class="task-meta">
                            Worker: ${task.worker_id} |
                            ${task.started ? 'Started: ' + task.started : ''}
                            ${task.pid ? '| PID: ' + task.pid : ''}
                        </div>
                    </li>
                `).join('');
            }
        }

        function updateThermal(thermal) {
            const metric = document.getElementById('thermal-metric');
            const tempValue = document.getElementById('cpu-temp');

            metric.style.display = 'flex';
            tempValue.textContent = thermal.cpu_temp + '¬∞C';

            // Color code temperature
            if (thermal.cpu_temp > 70) {
                tempValue.className = 'metric-value status-error';
            } else if (thermal.cpu_temp > 60) {
                tempValue.className = 'metric-value status-warning';
            } else {
                tempValue.className = 'metric-value status-good';
            }
        }

        // Initial update
        updateDashboard();

        // Set up auto-refresh
        setInterval(updateDashboard, UPDATE_INTERVAL);
    </script>
</body>
</html>
